[gcode_macro START_PRINT]
gcode:
  {% set T_BED = params.T_BED | default(90) | float %}
  {% set T_EXTRUDER = params.T_EXTRUDER | default(230) | float %}
  {% set T_CHAMBER = params.T_CHAMBER | default(0) | float %}
  {% set TOOL_NR = params.TOOL_NR | default(0) | int %}
  G21 ;metric values
  G90 ;absolute positioning
  M82 ;set extruder to absolute mode
  M107 ;start with the fan off
  T0
  START_CHECK0
  FILAMENT_CHECK1
  M140 S{T_BED}
  M104 S160
  SET_HEATER_TEMPERATURE HEATER=chamber TARGET={T_CHAMBER}
  PARK_EXTRUDER ;park tool0
  M190 S{T_BED}
  M109 S160
  G4 P60000 ;pause
  GET_EXTRUDER ;get tool0
  G1 Z3 F900
  BED_ALIGNMENT ;bed tilt adjustment
  BED_MESH_CALIBRATE PRINT_MIN={params.PRINT_MIN} PRINT_MAX={params.PRINT_MAX} ;auto bed level
  G1 Z3 F1200 ;move the platform up 3mm
  M104 S0 ;turn off tool0 heater
  T{TOOL_NR} ;take printing tool
  PARK_EXTRUDER{TOOL_NR}
  M104 S{T_EXTRUDER}
  M109 S{T_EXTRUDER}
  GET_EXTRUDER{TOOL_NR}
  INTRO_LINE

[gcode_macro END_PRINT]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set T_CHAMBER = params.T_CHAMBER | default(0) | float %}
  {% set COOLDOWN_TIME = params.COOLDOWN_TIME | default(60) | float *60000 %}
  {% set SHUTDOWN_TEMP = params.SHUTDOWN_TEMP | default(60) | float %}
  G91 ;relative positioning
  G1 E-2 F2000 ;start retract
  G1 Z+3 E-6 F5000 ;continue retract
  G90 ;absolute positioning
  T0
  G1 X{svv.t0x_park} Y{svv.t0y_park} F{svv.speed_fast}
  #Z_MAX
  TURN_OFF_HEATERS
  FILAMENT_CHECK0
  M82
  COOLDOWN
  M106 S255
  SET_FAN_SPEED FAN=Chamber_fan SPEED=1
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={SHUTDOWN_TEMP}
  TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={SHUTDOWN_TEMP}
  M81 ;power off

[gcode_macro COOLDOWN]
gcode:
  {% set target_temp = params.T_CHAMBER | default(0) | int %}
  {% set COOLDOWN_TIME = params.COOLDOWN_TIME | default(120) | float *60000 %}
  {% set N = ((target_temp - 25)/10) | round(0) | int %}
  {% set DELTA_TIME = COOLDOWN_TIME/N | int %}
  {% set DISPLAYED_TIME = (DELTA_TIME/60000) | round(1) %}
  {% set ALL_DISPLAYED_TIME = DISPLAYED_TIME*N %}

  {% if target_temp != 0 %}
    M118 Начинаем отпуск детали! 
    M118 Количество итераций - {N}.
    M118 Общее время ожидания {ALL_DISPLAYED_TIME} минут.
    {% for i in range(target_temp, 25, -10) %}
      SET_HEATER_TEMPERATURE HEATER=chamber TARGET={i}
      M118 Температура отпуска = {i} градусов.
      {% if i != 25 %}
        M118 время ожидания итерации {DISPLAYED_TIME} минут.
        G4 P{DELTA_TIME}
      {% endif %}
    {% endfor %}
    M118 Отпуск детали завершён!!!
    SET_HEATER_TEMPERATURE HEATER=chamber TARGET=0
  {% endif %}

[gcode_macro INTRO_LINE]
gcode:
  {% set svv = printer.save_variables.variables %}
  G92 E0 ;zero the extruded length
  G1 X150 Y400 F18000
  G1 Z0.3 F2000
  G1 X200 E10 F1500
  G1 X250 E18 F1000
  G92 E0

[gcode_macro PAUSE]
description: Pause print.
rename_existing: BASE_PAUSE
variable_extrude: 6.0
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  {% set max_z = printer.toolhead.axis_maximum.z|float -1 %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% set z_safe = max_z - act_z %}
  SAVE_GCODE_STATE NAME=PAUSE_state
  BASE_PAUSE
  #G91
  #G1 E-{E} F2100
  G90
  G1 X10 Y10 Z{max_z} F1500

[gcode_macro RESUME]
description: Resume print.
rename_existing: BASE_RESUME
gcode:
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  G91
  G1 E{E} F2100
  RESTORE_GCODE_STATE NAME=PAUSE_state
  BASE_RESUME

[gcode_macro CANCEL_PRINT]
description: Cancel print.
rename_existing: BASE_CANCEL_PRINT
gcode:
  G90
  G1 X10 Y290 F9000
  Z_MAX
  FILAMENT_CHECK0
  RESTART

[gcode_macro PID_CALIBRATE_HOTEND0]
description: Run PID calibration for hotend.
gcode:
    PID_CALIBRATE HEATER=extruder TARGET=235

[gcode_macro PID_CALIBRATE_HOTEND1]
description: Run PID calibration for hotend.
gcode:
    PID_CALIBRATE HEATER=extruder1 TARGET=235

[gcode_macro PID_CALIBRATE_BED]
description: Run PID calibration for bed.
gcode:
    PID_CALIBRATE HEATER=heater_bed TARGET=90
    SAVE_CONFIG 

[gcode_macro BED_ALIGNMENT]
gcode:
    G21 ;metric values
    G90 ;absolute positioning
    G28 X0 Y0 Z0 ;Home all

    ; 1 итерация

    G1 Z3 F1200
    G1 X10 Y0 F12000
    PROBE
    GZ0 ; macros - save probe result to Z0 variable

    G1 Z3 F1200
    G1 X10 Y350 F12000
    PROBE
    GZ1 ; macros - save probe result to Z1 variable

    G1 Z3 F1200
    G1 X410 Y350 F12000
    PROBE
    GZ2 ; macros - save probe result to Z2 variable

    G1 Z3 F1200
    G1 X410 Y0 F12000
    PROBE
    GZ3 ; macros - save probe result to Z3 variable

    z_info

    G1 Z3 F1200
    G1 X210 Y200 F12000

    ;выравниваем плоскоть стола ...
    quad_z_tilt_adjust

    ; 2 итерация

    G1 Z3 F1200
    G1 X10 Y0 F12000
    PROBE
    GZ0 ; macros - save probe result to Z0 variable

    G1 Z3 F1200
    G1 X10 Y350 F12000
    PROBE
    GZ1 ; macros - save probe result to Z1 variable

    G1 Z3 F1200
    G1 X410 Y350 F12000
    PROBE
    GZ2 ; macros - save probe result to Z2 variable

    G1 Z3 F1200
    G1 X410 Y0 F12000
    PROBE
    GZ3 ; macros - save probe result to Z3 variable

    z_info

    G1 Z3 F1200
    G1 X210 Y200 F12000

    ;выравниваем плоскоть стола ...
    quad_z_tilt_adjust

    ; 3 итерация

    G1 Z3 F1200
    G1 X10 Y0 F12000
    PROBE
    GZ0 ; macros - save probe result to Z0 variable

    G1 Z3 F1200
    G1 X10 Y350 F12000
    PROBE
    GZ1 ; macros - save probe result to Z1 variable

    G1 Z3 F1200
    G1 X410 Y350 F12000
    PROBE
    GZ2 ; macros - save probe result to Z2 variable

    G1 Z3 F1200
    G1 X410 Y0 F12000
    PROBE
    GZ3 ; macros - save probe result to Z3 variable

    z_info

    G1 Z3 F1200
    G1 X210 Y200 F12000

    ;выравниваем плоскоть стола ...
    quad_z_tilt_adjust

    G28 X0 Y0

